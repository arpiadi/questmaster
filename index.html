<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            transition: background-color 0.3s ease;
        }

        .quest-card { transition: all 0.2s ease; }
        .progress-bar { transition: width 0.5s ease-out; }
        .checkbox-custom { width: 24px; height: 24px; cursor: pointer; }
        .delete-btn { display: none; }
        .edit-mode .delete-btn { display: flex; }
        .edit-mode .checkbox-container { display: none; }
        .locked-quest { opacity: 0.7; pointer-events: none; }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed; top: -10px; width: 10px; height: 10px;
            z-index: 200; animation: confetti 3s linear forwards;
        }
    </style>
</head>
<body class="pb-24">

    <!-- Header & Profil -->
    <div id="app-header" class="p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-all duration-500">
        <div class="flex justify-between items-start mb-4">
            <div class="flex flex-col gap-2">
                <button onclick="toggleThemeMenu()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold backdrop-blur-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Ganti Tema
                </button>
                <div class="flex items-center gap-2">
                    <h1 id="theme-title" class="text-2xl font-bold leading-tight truncate max-w-[180px]">Nama Tema</h1>
                </div>
            </div>
            <div class="text-right flex flex-col items-end gap-2">
                <span id="level-badge" class="bg-yellow-400 text-gray-900 px-3 py-1 rounded-full font-bold text-sm shadow-sm">LVL 1</span>
                <span id="xp-title" class="px-2 py-1 rounded-lg font-semibold text-base shadow-md bg-white text-indigo-600 border border-indigo-300">Pemula</span>
                <!-- Tambahkan tombol untuk membuka modal edit gelar -->
                <button onclick="openEditTitlesModal()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md">Edit Gelar</button>
            </div>
        </div>

        <div class="space-y-2">
            <div class="flex justify-between text-sm font-semibold">
                <span id="rank-label">XP Progress</span>
                <span id="xp-text">0 / 500 XP</span>
            </div>
            <div class="w-full bg-black/20 rounded-full h-4 overflow-hidden border border-white/10">
                <div id="xp-progress-bar" class="bg-yellow-400 h-full progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-xs font-medium">
                <div class="flex items-center gap-1"><span>üî• Streak: </span><span id="streak-count" class="font-bold">0 Hari</span></div>
                <div class="flex items-center gap-1"><span>üèÜ Total XP: </span><span id="total-xp" class="font-bold">0</span></div>
            </div>
        </div>
    </div>

    <!-- Tab View Switcher -->
    <div class="flex border-b bg-white sticky top-[210px] z-40">
        <button onclick="switchView('quests')" id="tab-quests" class="flex-1 py-3 font-bold transition-all border-b-2">Quests</button>
        <button onclick="switchView('rewards')" id="tab-rewards" class="flex-1 py-3 font-bold transition-all border-b-2">Rewards</button>
    </div>

    <main class="p-4 max-w-md mx-auto">
        <!-- Tampilan Quests -->
        <div id="view-quests" class="space-y-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 flex justify-between items-center" id="summary-card">
                <div>
                    <h2 class="font-bold text-gray-700">Skor Hari Ini: <span id="daily-xp" class="text-xl">0</span> XP</h2>
                    <p id="lock-status" class="text-[10px] text-gray-400 mt-1">Status: Terbuka</p>
                </div>
                <div id="edit-indicator" class="hidden text-red-500 font-bold text-xs animate-pulse">MODE EDIT</div>
            </div>
            <div id="quest-categories-container" class="space-y-8 pb-10"></div>
        </div>

        <!-- Tampilan Rewards -->
        <div id="view-rewards" class="hidden space-y-6 pb-10">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-lg">Target Hadiah</h3>
                <button onclick="openAddRewardModal()" id="btn-add-reward" class="text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md">+ Tambah</button>
            </div>
            <div id="rewards-container" class="space-y-3"></div>
        </div>
    </main>

    <!-- Drawer Pemilih Tema -->
    <div id="theme-menu" class="fixed inset-0 bg-black/50 z-[100] hidden items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Pilih Tema Quest</h3>
                <!-- Tombol Tambah Tema -->
                <button onclick="openAddThemeModal()" class="text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md bg-indigo-600">+ Tambah Tema</button>
            </div>
            <div id="theme-list-container" class="grid grid-cols-1 gap-3"></div>
            <button onclick="toggleThemeMenu()" class="w-full mt-6 py-3 text-gray-500 font-bold">Tutup</button>
        </div>
    </div>

    <!-- Modal Milestone -->
    <div id="milestone-modal" class="fixed inset-0 bg-black/80 z-[200] hidden flex-col items-center justify-center p-6 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl">
            <h2 id="milestone-icon" class="text-4xl mb-4">üëë</h2>
            <h1 class="text-3xl font-black mb-2" id="milestone-text">Luar Biasa!</h1>
            <p id="milestone-desc-text" class="text-gray-600 mb-6 font-medium"></p>
            <button onclick="closeMilestone()" id="milestone-close-btn" class="text-white px-10 py-3 rounded-full font-bold shadow-xl">LANJUTKAN</button>
        </div>
    </div>

    <!-- Bar Aksi Bawah -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 flex justify-around items-center z-50">
        <button onclick="resetDaily()" class="flex flex-col items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            <span class="text-[10px]">Ulang</span>
        </button>
        <button onclick="importData()" class="flex flex-col items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
            <span class="text-[10px]">Impor</span>
        </button>
        <button onclick="saveProgress()" id="btn-save" class="text-white px-8 py-2 rounded-full font-bold shadow-lg active:opacity-80 transition-all">Simpan Progres</button>
        <button onclick="exportData()" class="flex flex-col items-center text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            <span class="text-[10px]">Ekspor</span>
        </button>
    </div>

    <!-- Modal Umum -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-6 z-[110]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-desc" class="text-gray-600 mb-6 text-sm"></p>
            <button onclick="closeModal()" id="modal-btn" class="w-full text-white py-2 rounded-xl font-bold">Oke!</button>
        </div>
    </div>

    <!-- Modal Input -->
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-6 z-[110]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 id="input-modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <div class="space-y-4" id="input-modal-fields"></div>
            <div class="flex gap-2 pt-4">
                <button onclick="closeInputModal()" class="flex-1 py-3 text-gray-500 font-bold">Batal</button>
                <button id="input-modal-confirm" class="flex-1 py-3 text-white rounded-xl font-bold shadow-lg">Konfirmasi</button>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Tema -->
    <div id="add-theme-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[110]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Tambah Tema Baru</h3>
            <div class="space-y-4">
                <input type="text" id="new-theme-title" placeholder="Nama Tema" class="w-full p-3 bg-gray-100 rounded-xl">
                <select id="new-theme-accent" class="w-full p-3 bg-gray-100 rounded-xl">
                    <option value="indigo">Indigo</option>
                    <option value="emerald">Emerald</option>
                    <option value="rose">Rose</option>
                    <option value="amber">Amber</option>
                    <option value="violet">Violet</option>
                </select>
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="closeAddThemeModal()" class="flex-1 py-3 text-gray-500 font-bold">Batal</button>
                <button onclick="addNewTheme()" class="flex-1 py-3 text-white rounded-xl font-bold shadow-lg bg-indigo-600">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Gelar -->
    <div id="edit-titles-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[110]">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Gelar</h3>
            <div id="titles-list" class="space-y-4">
                <!-- Daftar gelar akan dirender di sini -->
            </div>
            <button onclick="addNewTitle()" class="w-full mt-4 py-2 bg-indigo-600 text-white rounded-lg font-bold">+ Tambah Gelar</button>
            <div class="flex gap-2 pt-4">
                <button onclick="closeEditTitlesModal()" class="flex-1 py-3 text-gray-500 font-bold">Batal</button>
                <button onclick="saveTitles()" class="flex-1 py-3 text-white rounded-xl font-bold shadow-lg bg-indigo-600">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        const colorPresets = {
            indigo: { bg: 'bg-indigo-600', light: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-600', darkText: 'text-indigo-900', hex: '#4f46e5' },
            emerald: { bg: 'bg-emerald-600', light: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-600', darkText: 'text-emerald-900', hex: '#059669' },
            rose: { bg: 'bg-rose-600', light: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-600', darkText: 'text-rose-900', hex: '#e11d48' },
            amber: { bg: 'bg-amber-600', light: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-600', darkText: 'text-amber-900', hex: '#d97706' },
            violet: { bg: 'bg-violet-600', light: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-600', darkText: 'text-violet-900', hex: '#7c3aed' }
        };

        let globalState = {
            currentTheme: 'health',
            themes: {
                health: { 
                    title: 'Health Quest', accent: 'indigo', totalXp: 0, dailyChecked: {}, streak: 0, lastSaveDate: '', 
                    customQuests: {
                        wajib: { title: "üìú Quest Wajib", items: [{ id: 'hw1', label: 'Minum Air 2L', xp: 20 }, { id: 'hw2', label: 'Olahraga 15m', xp: 50 }] },
                        bonus: { title: "üîµ Quest Bonus", items: [{ id: 'hb1', label: 'Meditasi', xp: 10 }] },
                        negatif: { title: "üî¥ Quest Negatif", items: [{ id: 'hn1', label: 'Makan Junk Food', xp: -30 }] }
                    }, 
                    rewards: []
                },
                work: {
                    title: 'Work Mode', accent: 'emerald', totalXp: 0, dailyChecked: {}, streak: 0, lastSaveDate: '',
                    customQuests: {
                        wajib: { title: "üíº Pekerjaan Utama", items: [{ id: 'ww1', label: 'Selesaikan Task', xp: 30 }] },
                        bonus: { title: "üöÄ Bonus Skill", items: [{ id: 'wb1', label: 'Belajar 30m', xp: 20 }] },
                        negatif: { title: "üì± Distraksi", items: [{ id: 'wn1', label: 'Sosmed > 1 jam', xp: -20 }] }
                    },
                    rewards: []
                }
            }
        };

        let isEditMode = false;
        let activeView = 'quests';

        // Daftar gelar yang dapat diedit
        let titles = [
            { name: "Pemula", xp: 0 },
            { name: "Disiplin Muscle", xp: 500 },
            { name: "Master Quest", xp: 2000 },
            { name: "Elite Achiever", xp: 5000 },
            { name: "Legendary Hero", xp: 10000 }
        ];

        function init() {
            const saved = localStorage.getItem('quest_master_v7_full');
            if (saved) {
                globalState = JSON.parse(saved);
            }
            checkDateReset();
            applyThemeStyles();
            renderAll();
            updateUI();
        }

        function checkDateReset() {
            const today = new Date().toLocaleDateString();
            Object.keys(globalState.themes).forEach(key => {
                const theme = globalState.themes[key];
                if (theme.lastSaveDate !== today) {
                    theme.dailyChecked = {}; 
                }
            });
            saveToStorage();
        }

        function isTodaySaved() {
            const theme = globalState.themes[globalState.currentTheme];
            return theme.lastSaveDate === new Date().toLocaleDateString();
        }

        function applyThemeStyles() {
            const theme = globalState.themes[globalState.currentTheme];
            const preset = colorPresets[theme.accent] || colorPresets.indigo;
            
            document.getElementById('app-header').className = `${preset.bg} text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-all duration-500`;
            document.getElementById('btn-save').className = `${preset.bg} text-white px-8 py-2 rounded-full font-bold shadow-lg active:opacity-80 transition-all`;
            document.getElementById('btn-add-reward').className = `${preset.bg} text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md`;
            
            const tabQ = document.getElementById('tab-quests');
            const tabR = document.getElementById('tab-rewards');
            tabQ.className = `flex-1 py-3 font-bold ${activeView==='quests' ? preset.text : 'text-gray-400'} border-b-2 ${activeView==='quests' ? 'border-current' : 'border-transparent'}`;
            tabR.className = `flex-1 py-3 font-bold ${activeView==='rewards' ? preset.text : 'text-gray-400'} border-b-2 ${activeView==='rewards' ? 'border-current' : 'border-transparent'}`;
            
            document.getElementById('modal-btn').className = `w-full ${preset.bg} text-white py-2 rounded-xl font-bold`;
            document.getElementById('input-modal-confirm').className = `flex-1 py-3 ${preset.bg} text-white rounded-xl font-bold shadow-lg`;
            document.getElementById('summary-card').style.borderLeftColor = preset.hex;
        }

        function renderAll() {
            renderQuests();
            renderRewards();
            renderThemeList();
        }

        function renderQuests() {
            const theme = globalState.themes[globalState.currentTheme];
            const preset = colorPresets[theme.accent];
            const container = document.getElementById('quest-categories-container');
            const saved = isTodaySaved();
            container.innerHTML = '';

            Object.keys(theme.customQuests).forEach(catKey => {
                const category = theme.customQuests[catKey];
                const section = document.createElement('section');
                if(isEditMode) section.classList.add('edit-mode');
                
                let itemsHtml = '';
                category.items.forEach(item => {
                    const isChecked = theme.dailyChecked[item.id] || false;
                    const isLocked = saved && isChecked; 

                    itemsHtml += `
                        <div class="quest-card bg-white p-3 rounded-xl shadow-sm flex items-center justify-between border border-transparent ${isChecked ? preset.border + ' ' + preset.light : ''} ${isLocked ? 'locked-quest' : ''}" onclick="toggleQuest('${item.id}', ${item.xp})">
                            <div class="flex-1 mr-4">
                                <h4 class="font-semibold text-sm ${isChecked ? 'line-through text-gray-400' : 'text-gray-700'}">${item.label}</h4>
                                ${isLocked ? '<span class="text-[8px] font-bold text-green-600 uppercase">‚úì Terkunci</span>' : ''}
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold ${item.xp > 0 ? 'text-green-500' : 'text-red-500'}">${item.xp > 0 ? '+' : ''}${item.xp}</span>
                                <div class="checkbox-container">
                                    <input type="checkbox" ${isChecked ? 'checked' : ''} class="checkbox-custom" style="accent-color: ${preset.hex}" onclick="event.stopPropagation(); toggleQuest('${item.id}', ${item.xp})">
                                </div>
                                <button onclick="event.stopPropagation(); deleteQuest('${catKey}', '${item.id}')" class="delete-btn bg-red-100 text-red-600 p-2 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </button>
                            </div>
                        </div>`;
                });

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800">${category.title}</h3>
                        ${isEditMode ? `<button onclick="openAddQuestModal('${catKey}')" class="${preset.text} text-xs font-bold">+ Quest</button>` : ''}
                    </div>
                    <div class="space-y-2">${itemsHtml || '<p class="text-center text-xs text-gray-400 py-2">Belum ada quest</p>'}</div>`;
                container.appendChild(section);
            });
        }

        function toggleQuest(id, xp) {
            if(isEditMode) return;
            const theme = globalState.themes[globalState.currentTheme];
            const saved = isTodaySaved();

            if (theme.dailyChecked[id]) {
                if (saved) {
                    notify("Terkunci", "Hanya bisa dibatalkan besok hari.");
                    return;
                }
                delete theme.dailyChecked[id];
                theme.totalXp -= xp;
            } else {
                theme.dailyChecked[id] = true;
                theme.totalXp += xp;
            }
            
            if(theme.totalXp < 0) theme.totalXp = 0;
            saveToStorage();
            renderQuests();
            updateUI();
        }

        function saveProgress() {
            const theme = globalState.themes[globalState.currentTheme];
            const today = new Date().toLocaleDateString();
            
            if (theme.lastSaveDate === today) {
                return notify("Sudah Tersimpan", "Progres hari ini telah terkunci.");
            }
            
            theme.lastSaveDate = today;
            theme.streak++;
            saveToStorage();
            renderQuests(); 
            updateUI();
            notify("Tersimpan!", "Data telah dikunci di memori browser.");
        }

        // Fungsi untuk membuka modal edit gelar
        function openEditTitlesModal() {
            const container = document.getElementById('titles-list');
            container.innerHTML = '';
            titles.forEach((title, index) => {
                container.innerHTML += `
                    <div class="flex items-center gap-2">
                        <input type="text" value="${title.name}" class="flex-1 p-2 bg-gray-100 rounded-lg border" onchange="updateTitleName(${index}, this.value)">
                        <input type="number" value="${title.xp}" class="w-24 p-2 bg-gray-100 rounded-lg border" onchange="updateTitleXP(${index}, this.value)">
                        <button onclick="deleteTitle(${index})" class="text-red-500 font-bold">Hapus</button>
                    </div>
                `;
            });
            document.getElementById('edit-titles-modal').classList.replace('hidden', 'flex');
        }

        // Fungsi untuk menutup modal edit gelar
        function closeEditTitlesModal() {
            document.getElementById('edit-titles-modal').classList.replace('flex', 'hidden');
        }

        // Fungsi untuk menambah gelar baru
        function addNewTitle() {
            titles.push({ name: "Gelar Baru", xp: 0 });
            openEditTitlesModal();
        }

        // Fungsi untuk memperbarui nama gelar
        function updateTitleName(index, value) {
            titles[index].name = value;
        }

        // Fungsi untuk memperbarui XP gelar
        function updateTitleXP(index, value) {
            titles[index].xp = parseInt(value, 10) || 0;
        }

        // Fungsi untuk menghapus gelar
        function deleteTitle(index) {
            if (titles.length > 1) {
                titles.splice(index, 1);
                openEditTitlesModal();
            } else {
                alert("Minimal harus ada satu gelar.");
            }
        }

        // Fungsi untuk menyimpan gelar
        function saveTitles() {
            titles.sort((a, b) => a.xp - b.xp); // Urutkan berdasarkan XP
            closeEditTitlesModal();
            updateUI();
        }

        // Fungsi untuk menentukan gelar berdasarkan XP
        function getTitleByXP(xp) {
            let title = "Tidak Diketahui";
            for (let i = titles.length - 1; i >= 0; i--) {
                if (xp >= titles[i].xp) {
                    title = titles[i].name;
                    break;
                }
            }
            return title;
        }

        function updateUI() {
            const theme = globalState.themes[globalState.currentTheme];
            const level = Math.floor(theme.totalXp / 500) + 1;
            const xpInLevel = theme.totalXp % 500;
            const saved = isTodaySaved();

            document.getElementById('level-badge').innerText = `LVL ${level}`;
            document.getElementById('xp-text').innerText = `${xpInLevel} / 500 XP`;
            document.getElementById('xp-progress-bar').style.width = `${(xpInLevel / 500) * 100}%`;
            document.getElementById('total-xp').innerText = theme.totalXp;
            document.getElementById('streak-count').innerText = `${theme.streak} Hari`;
            document.getElementById('theme-title').innerText = theme.title;
            document.getElementById('lock-status').innerText = saved ? "Status: Terkunci" : "Status: Terbuka";

            let daily = 0;
            Object.keys(theme.dailyChecked).forEach(id => {
                Object.values(theme.customQuests).forEach(cat => {
                    const item = cat.items.find(i => i.id === id);
                    if(item) daily += item.xp;
                });
            });
            document.getElementById('daily-xp').innerText = daily;

            // Perbarui gelar berdasarkan total XP
            const title = getTitleByXP(theme.totalXp);
            const xpTitleElement = document.getElementById('xp-title');
            xpTitleElement.innerText = title;

            // Sesuaikan warna latar belakang dan teks gelar berdasarkan tema
            const preset = colorPresets[theme.accent] || colorPresets.indigo;
            xpTitleElement.className = `px-2 py-1 rounded-lg font-semibold text-base shadow-md ${preset.text} bg-white border ${preset.border}`;
        }

        function renderRewards() {
            const theme = globalState.themes[globalState.currentTheme];
            const container = document.getElementById('rewards-container');
            container.innerHTML = '';
            theme.rewards.forEach((r, idx) => {
                const progress = Math.min((theme.totalXp / r.cost) * 100, 100);
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm relative">
                        <div class="flex justify-between mb-2"><span class="font-bold text-gray-700">${r.name}</span><span class="text-xs font-bold text-gray-400">${theme.totalXp} / ${r.cost} XP</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div class="${colorPresets[theme.accent].bg} h-full" style="width: ${progress}%"></div></div>
                        <button onclick="deleteReward(${idx})" class="absolute top-1 right-2 text-[10px] text-red-300">hapus</button>
                    </div>`;
            });
        }

        // Fungsi untuk membuka modal tambah tema
        function openAddThemeModal() {
            document.getElementById('add-theme-modal').classList.replace('hidden', 'flex');
        }

        // Fungsi untuk menutup modal tambah tema
        function closeAddThemeModal() {
            document.getElementById('add-theme-modal').classList.replace('flex', 'hidden');
        }

        // Fungsi untuk menambahkan tema baru
        function addNewTheme() {
            const title = document.getElementById('new-theme-title').value.trim();
            const accent = document.getElementById('new-theme-accent').value;

            if (!title) {
                notify("Gagal", "Nama tema tidak boleh kosong.");
                return;
            }

            const newThemeKey = title.toLowerCase().replace(/\s+/g, '_');
            if (globalState.themes[newThemeKey]) {
                notify("Gagal", "Tema dengan nama ini sudah ada.");
                return;
            }

            globalState.themes[newThemeKey] = {
                title,
                accent,
                totalXp: 0,
                dailyChecked: {},
                streak: 0,
                lastSaveDate: '',
                customQuests: {
                    wajib: { title: "üìú Quest Wajib", items: [] },
                    bonus: { title: "üîµ Quest Bonus", items: [] },
                    negatif: { title: "üî¥ Quest Negatif", items: [] }
                },
                rewards: []
            };

            saveToStorage();
            renderThemeList();
            closeAddThemeModal();
            notify("Berhasil", "Tema baru berhasil ditambahkan.");
        }

        // Fungsi untuk menghapus tema
        function deleteTheme(key) {
            if (Object.keys(globalState.themes).length <= 1) {
                notify("Gagal", "Minimal harus ada satu tema.");
                return;
            }

            if (confirm(`Apakah Anda yakin ingin menghapus tema "${globalState.themes[key].title}"?`)) {
                delete globalState.themes[key];
                if (globalState.currentTheme === key) {
                    globalState.currentTheme = Object.keys(globalState.themes)[0];
                }
                saveToStorage();
                renderThemeList();
                applyThemeStyles();
                renderAll();
                updateUI();
                notify("Berhasil", "Tema berhasil dihapus.");
            }
        }

        // Perbarui renderThemeList untuk menambahkan tombol hapus
        function renderThemeList() {
            const container = document.getElementById('theme-list-container');
            container.innerHTML = '';
            Object.keys(globalState.themes).forEach(key => {
                const t = globalState.themes[key];
                container.innerHTML += `
                    <div class="flex items-center gap-3">
                        <button onclick="switchTheme('${key}')" class="flex-1 text-left p-4 rounded-2xl ${colorPresets[t.accent].light} border-2 ${globalState.currentTheme === key ? colorPresets[t.accent].border : 'border-transparent'}">
                            <p class="font-bold ${colorPresets[t.accent].darkText}">${t.title}</p>
                        </button>
                        <button onclick="deleteTheme('${key}')" class="text-red-500 text-sm font-bold">Hapus</button>
                    </div>`;
            });
        }

        function switchTheme(key) { globalState.currentTheme = key; applyThemeStyles(); renderAll(); updateUI(); toggleThemeMenu(); }
        function toggleThemeMenu() { const m = document.getElementById('theme-menu'); m.classList.toggle('hidden'); m.classList.toggle('flex'); }
        function switchView(view) { activeView = view; applyThemeStyles(); document.getElementById('view-quests').classList.toggle('hidden', view !== 'quests'); document.getElementById('view-rewards').classList.toggle('hidden', view !== 'rewards'); }
        function toggleEditMode() { isEditMode = !isEditMode; document.getElementById('edit-master-btn').classList.toggle('bg-red-500', isEditMode); document.getElementById('edit-indicator').classList.toggle('hidden', !isEditMode); renderQuests(); }
        
        function openAddQuestModal(cat) {
            openInputModal("Tambah Quest", `<input type="text" id="q-label" placeholder="Nama Quest" class="w-full p-3 bg-gray-100 rounded-xl mb-2"><input type="number" id="q-xp" placeholder="XP (Misal: 20)" class="w-full p-3 bg-gray-100 rounded-xl">`, () => {
                const label = document.getElementById('q-label').value;
                const xp = parseInt(document.getElementById('q-xp').value);
                if(label && !isNaN(xp)) { globalState.themes[globalState.currentTheme].customQuests[cat].items.push({ id: 'q_'+Date.now(), label, xp }); saveToStorage(); renderQuests(); closeInputModal(); }
            });
        }

        function deleteQuest(cat, id) {
            const theme = globalState.themes[globalState.currentTheme];
            theme.customQuests[cat].items = theme.customQuests[cat].items.filter(i => i.id !== id);
            delete theme.dailyChecked[id];
            saveToStorage(); renderQuests(); updateUI();
        }

        function openAddRewardModal() {
            openInputModal("Tambah Hadiah", `<input type="text" id="rew-name" placeholder="Misal: Beli Game" class="w-full p-3 bg-gray-100 rounded-xl mb-2"><input type="number" id="rew-cost" placeholder="Target XP" class="w-full p-3 bg-gray-100 rounded-xl">`, () => {
                const name = document.getElementById('rew-name').value;
                const cost = parseInt(document.getElementById('rew-cost').value);
                if(name && cost) { globalState.themes[globalState.currentTheme].rewards.push({ name, cost }); saveToStorage(); renderRewards(); closeInputModal(); }
            });
        }

        function deleteReward(idx) { globalState.themes[globalState.currentTheme].rewards.splice(idx, 1); saveToStorage(); renderRewards(); }
        
        function openInputModal(title, html, onConfirm) {
            document.getElementById('input-modal-title').innerText = title;
            document.getElementById('input-modal-fields').innerHTML = html;
            document.getElementById('input-modal-confirm').onclick = onConfirm;
            document.getElementById('input-modal').classList.replace('hidden', 'flex');
        }
        function closeInputModal() { document.getElementById('input-modal').classList.replace('flex', 'hidden'); }
        function notify(title, desc) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-desc').innerText = desc; document.getElementById('modal').classList.replace('hidden', 'flex'); }
        function closeModal() { document.getElementById('modal').classList.replace('flex', 'hidden'); }
        
        function saveToStorage() { 
            localStorage.setItem('quest_master_v7_full', JSON.stringify(globalState)); 
        }

        function resetDaily() { if(confirm("Hapus centang hari ini? XP tersimpan tetap aman.")) { globalState.themes[globalState.currentTheme].dailyChecked = {}; renderQuests(); updateUI(); } }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(globalState)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_quest_${Date.now()}.json`;
            a.click();
            notify("Ekspor Berhasil", "File backup telah diunduh. Simpan file ini.");
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = ".json";
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        globalState = imported;
                        saveToStorage();
                        location.reload();
                    } catch(e) { notify("Gagal", "File tidak valid!"); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        window.onload = init;
    </script>
</body>
</html>