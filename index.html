<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            transition: background-color 0.3s ease;
            overscroll-behavior-y: none;
        }

        .quest-card { transition: all 0.2s ease; }
        .progress-bar { transition: width 0.5s ease-out; }
        .checkbox-custom { width: 24px; height: 24px; cursor: pointer; }
        /* Removed locked-quest style as it is no longer needed */

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed; top: -10px; width: 10px; height: 10px;
            z-index: 200; animation: confetti 3s linear forwards;
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="pb-32">

    <!-- Header & Profil -->
    <div id="app-header" class="p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-all duration-500 bg-indigo-600 text-white">
        <div class="flex justify-between items-start mb-4">
            <div class="flex flex-col gap-2">
                <button onclick="toggleThemeMenu()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold backdrop-blur-sm flex items-center gap-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Ganti Tema
                </button>
                <div class="flex items-center gap-2">
                    <h1 id="theme-title" class="text-2xl font-bold leading-tight truncate max-w-[180px]">Quest Master</h1>
                </div>
            </div>
            <div class="text-right flex flex-col items-end gap-2">
                <span id="level-badge" class="bg-yellow-400 text-gray-900 px-3 py-1 rounded-full font-bold text-sm shadow-sm">LVL 1</span>
                <span id="xp-title" class="px-2 py-1 rounded-lg font-semibold text-base shadow-md bg-white text-indigo-600 border border-indigo-300">Pemula</span>
                <button onclick="openEditTitlesModal()" class="bg-black/10 hover:bg-black/20 text-white px-3 py-1 rounded-lg text-[10px] font-bold transition-colors">Edit Gelar</button>
            </div>
        </div>

        <div class="space-y-2">
            <div class="flex justify-between text-sm font-semibold">
                <span id="rank-label">XP Progress</span>
                <span id="xp-text">0 / 500 XP</span>
            </div>
            <div class="w-full bg-black/20 rounded-full h-4 overflow-hidden border border-white/10">
                <div id="xp-progress-bar" class="bg-yellow-400 h-full progress-bar" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-xs font-medium">
                <div class="flex items-center gap-1"><span>üî• Streak: </span><span id="streak-count" class="font-bold">0 Hari</span></div>
                <div class="flex items-center gap-1"><span>üèÜ Total XP: </span><span id="total-xp" class="font-bold">0</span></div>
            </div>
        </div>
    </div>

    <!-- Tab View Switcher -->
    <div class="flex border-b bg-white sticky top-[180px] z-40 shadow-sm">
        <button onclick="switchView('quests')" id="tab-quests" class="flex-1 py-3 font-bold transition-all border-b-2 text-indigo-600 border-indigo-600">Quests</button>
        <button onclick="switchView('rewards')" id="tab-rewards" class="flex-1 py-3 font-bold transition-all border-b-2 text-gray-400 border-transparent hover:bg-gray-50">Rewards</button>
    </div>

    <main class="p-4 max-w-md mx-auto">
        <!-- Tampilan Quests -->
        <div id="view-quests" class="space-y-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 flex justify-between items-center transition-all" id="summary-card">
                <div>
                    <h2 class="font-bold text-gray-700">Skor Hari Ini: <span id="daily-xp" class="text-xl text-indigo-600">0</span> XP</h2>
                    <p class="text-[10px] text-gray-400 mt-1">Auto-Save Aktif</p>
                </div>
                <div id="edit-indicator" class="hidden text-red-500 font-bold text-xs animate-pulse border border-red-200 bg-red-50 px-2 py-1 rounded">MODE EDIT</div>
            </div>
            <div id="quest-categories-container" class="space-y-8 pb-10"></div>
        </div>

        <!-- Tampilan Rewards -->
        <div id="view-rewards" class="hidden space-y-6 pb-10">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-lg">Target Hadiah</h3>
                <button onclick="openAddRewardModal()" id="btn-add-reward" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md transition-colors">+ Tambah</button>
            </div>
            <div id="rewards-container" class="space-y-3"></div>
            <div id="empty-rewards-msg" class="hidden text-center text-gray-400 text-sm py-8">
                Belum ada target hadiah. Tambahkan untuk memotivasi dirimu!
            </div>
        </div>
    </main>

    <!-- Drawer Pemilih Tema -->
    <div id="theme-menu" class="fixed inset-0 bg-black/50 z-[100] hidden items-end justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-md rounded-t-3xl p-6 max-h-[80vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Pilih Tema Quest</h3>
                <button onclick="openAddThemeModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md transition-colors">+ Tambah</button>
            </div>
            <div id="theme-list-container" class="grid grid-cols-1 gap-3"></div>
            <button onclick="toggleThemeMenu()" class="w-full mt-6 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Tutup</button>
        </div>
    </div>

    <!-- Bar Aksi Bawah -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 pb-6 md:pb-2 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] px-6">
        <button onclick="resetDaily()" class="flex flex-col items-center text-gray-400 hover:text-gray-600 p-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            <span class="text-[10px] font-medium">Reset</span>
        </button>
        
        <button onclick="toggleEditMode()" id="btn-edit-mode" class="flex flex-col items-center text-gray-400 hover:text-gray-600 p-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            <span class="text-[10px] font-medium">Kelola</span>
        </button>

        <button onclick="exportData()" class="flex flex-col items-center text-gray-400 hover:text-gray-600 p-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            <span class="text-[10px] font-medium">Backup</span>
        </button>
        
        <button onclick="importData()" class="flex flex-col items-center text-gray-400 hover:text-gray-600 p-2 rounded-lg transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" transform="rotate(180 12 12)"/></svg>
            <span class="text-[10px] font-medium">Restore</span>
        </button>
    </div>

    <!-- Modals -->
    <!-- Add Theme Modal -->
    <div id="add-theme-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Tambah Tema</h3>
            <input type="text" id="new-theme-title" placeholder="Nama Tema (misal: Skripsi, Gym)" class="w-full p-3 bg-gray-100 rounded-xl mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <select id="new-theme-accent" class="w-full p-3 bg-gray-100 rounded-xl mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
                <option value="indigo">Indigo (Biru Ungu)</option>
                <option value="emerald">Emerald (Hijau)</option>
                <option value="rose">Rose (Merah Muda)</option>
                <option value="amber">Amber (Oranye)</option>
                <option value="violet">Violet (Ungu)</option>
            </select>
            <div class="flex gap-2">
                <button onclick="closeAddThemeModal()" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Batal</button>
                <button onclick="addNewTheme()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors">Tambah</button>
            </div>
        </div>
    </div>

    <!-- Edit Titles Modal -->
    <div id="edit-titles-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Gelar XP</h3>
            <div id="titles-list" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2"></div>
            <button onclick="addNewTitle()" class="w-full mt-4 py-2 border-2 border-dashed border-gray-300 hover:border-indigo-400 text-gray-400 hover:text-indigo-500 rounded-lg font-bold transition-all">+ Tambah Gelar</button>
            <div class="flex gap-2 pt-4">
                <button onclick="closeEditTitlesModal()" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Batal</button>
                <button onclick="saveTitles()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Edit Quest Modal -->
    <div id="edit-quest-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 id="edit-quest-modal-title" class="text-xl font-bold mb-4 text-gray-800">Edit Quest</h3>
            <div class="space-y-4">
                <input type="text" id="quest-name" placeholder="Nama Quest" class="w-full p-3 bg-gray-100 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                <input type="number" id="quest-xp" placeholder="XP (contoh: 20)" class="w-full p-3 bg-gray-100 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="closeEditQuestModal()" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Batal</button>
                <button onclick="saveQuest()" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors">Simpan</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[200] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-2 text-gray-800">Konfirmasi</h3>
            <p id="confirm-msg" class="text-gray-600 mb-6 text-sm">Apakah Anda yakin?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Batal</button>
                <button id="confirm-yes-btn" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors">Ya</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM PROMPT MODAL -->
    <div id="prompt-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[200] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="prompt-title" class="text-lg font-bold mb-4 text-gray-800">Input</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1 block mb-1">Nama Hadiah</label>
                    <input type="text" id="prompt-input-1" class="w-full p-3 bg-gray-100 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1 block mb-1">Biaya XP</label>
                    <input type="number" id="prompt-input-2" class="w-full p-3 bg-gray-100 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closePromptModal()" class="flex-1 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition-colors">Batal</button>
                <button id="prompt-submit-btn" class="flex-1 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition-colors">Simpan</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM MESSAGE MODAL -->
    <div id="msg-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-[200] backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
            <div id="msg-icon" class="mb-2 text-4xl">‚ú®</div>
            <p id="msg-text" class="text-gray-800 font-semibold mb-4"></p>
            <button onclick="closeMsgModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold w-full">Oke</button>
        </div>
    </div>

    <script>
        const colorPresets = {
            indigo: { bg: 'bg-indigo-600', light: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-600', darkText: 'text-indigo-900', hex: '#4f46e5' },
            emerald: { bg: 'bg-emerald-600', light: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-600', darkText: 'text-emerald-900', hex: '#059669' },
            rose: { bg: 'bg-rose-600', light: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-600', darkText: 'text-rose-900', hex: '#e11d48' },
            amber: { bg: 'bg-amber-600', light: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-600', darkText: 'text-amber-900', hex: '#d97706' },
            violet: { bg: 'bg-violet-600', light: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-600', darkText: 'text-violet-900', hex: '#7c3aed' }
        };

        let globalState = {
            currentTheme: 'health',
            themes: {
                health: { 
                    title: 'Health Quest', accent: 'indigo', totalXp: 0, dailyChecked: {}, streak: 0, lastActiveDate: '', 
                    customQuests: {
                        wajib: { title: "üìú Quest Wajib", items: [{ id: 'hw1', label: 'Minum Air 2L', xp: 20 }, { id: 'hw2', label: 'Olahraga 15m', xp: 50 }] },
                        bonus: { title: "üîµ Quest Bonus", items: [{ id: 'hb1', label: 'Meditasi', xp: 10 }] },
                        negatif: { title: "üî¥ Quest Negatif", items: [{ id: 'hn1', label: 'Makan Junk Food', xp: -30 }] }
                    }, 
                    rewards: []
                }
            }
        };

        let titles = [
            { name: "Pemula", xp: 0 },
            { name: "Disiplin", xp: 500 },
            { name: "Master", xp: 2000 },
            { name: "Legend", xp: 5000 }
        ];

        let isEditMode = false;
        let activeView = 'quests';
        let currentQuestCategory = null;
        let currentQuestIndex = null;
        let confirmAction = null;
        let promptAction = null;

        // --- Custom Modal Functions (Replacing Alert/Confirm/Prompt) ---

        function showConfirm(message, onYes) {
            document.getElementById('confirm-msg').innerText = message;
            confirmAction = onYes;
            document.getElementById('confirm-modal').classList.replace('hidden', 'flex');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.replace('flex', 'hidden');
            confirmAction = null;
        }

        document.getElementById('confirm-yes-btn').addEventListener('click', () => {
            if (confirmAction) confirmAction();
            closeConfirmModal();
        });

        function showPrompt(onSubmit) {
            document.getElementById('prompt-input-1').value = '';
            document.getElementById('prompt-input-2').value = '';
            promptAction = onSubmit;
            document.getElementById('prompt-modal').classList.replace('hidden', 'flex');
        }

        function closePromptModal() {
            document.getElementById('prompt-modal').classList.replace('flex', 'hidden');
            promptAction = null;
        }

        document.getElementById('prompt-submit-btn').addEventListener('click', () => {
            const val1 = document.getElementById('prompt-input-1').value;
            const val2 = document.getElementById('prompt-input-2').value;
            if (val1 && val2 && promptAction) {
                promptAction(val1, val2);
                closePromptModal();
            }
        });
        
        function showMessage(text, icon="‚ú®") {
            document.getElementById('msg-text').innerText = text;
            document.getElementById('msg-icon').innerText = icon;
            document.getElementById('msg-modal').classList.replace('hidden', 'flex');
        }
        
        function closeMsgModal() {
            document.getElementById('msg-modal').classList.replace('flex', 'hidden');
        }

        // --- Core Logic ---

        function init() {
            try {
                const saved = localStorage.getItem('quest_master_v7_full');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge with default to ensure structure exists
                    if (parsed.state) globalState = parsed.state;
                    if (parsed.titles) titles = parsed.titles;
                    
                    // Migration: Ensure lastActiveDate exists if migrating from old 'lastSaveDate'
                    Object.values(globalState.themes).forEach(t => {
                        if (t.lastSaveDate && !t.lastActiveDate) {
                            t.lastActiveDate = t.lastSaveDate;
                        }
                    });
                }
            } catch (e) {
                console.error("Error loading save:", e);
                showMessage("Gagal memuat data tersimpan. Memulai data baru.", "‚ö†Ô∏è");
            }
            
            // Validate currentTheme exists
            if (!globalState.themes[globalState.currentTheme]) {
                globalState.currentTheme = Object.keys(globalState.themes)[0];
            }

            checkDateReset();
            applyThemeStyles();
            renderAll();
            updateUI();
        }

        function saveToStorage() {
            localStorage.setItem('quest_master_v7_full', JSON.stringify({ state: globalState, titles: titles }));
        }

        // Clears daily checks if the day has changed since last activity
        function checkDateReset() {
            const today = new Date().toLocaleDateString();
            Object.keys(globalState.themes).forEach(key => {
                const theme = globalState.themes[key];
                // If there is a last active date recorded, and it's not today, clear the checks
                if (theme.lastActiveDate && theme.lastActiveDate !== today) {
                    theme.dailyChecked = {};
                    // Note: We do NOT update lastActiveDate here. It updates when user takes action.
                }
            });
            saveToStorage();
        }

        function applyThemeStyles() {
            const theme = globalState.themes[globalState.currentTheme];
            const preset = colorPresets[theme.accent] || colorPresets.indigo;
            
            document.getElementById('app-header').className = `${preset.bg} text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-50 transition-all duration-500`;
            document.getElementById('btn-add-reward').className = `${preset.bg} hover:opacity-90 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md transition-colors`;
            
            const tabQ = document.getElementById('tab-quests');
            const tabR = document.getElementById('tab-rewards');
            
            if (activeView === 'quests') {
                tabQ.className = `flex-1 py-3 font-bold transition-all border-b-2 ${preset.text} border-current`;
                tabR.className = `flex-1 py-3 font-bold transition-all border-b-2 text-gray-400 border-transparent hover:bg-gray-50`;
            } else {
                tabQ.className = `flex-1 py-3 font-bold transition-all border-b-2 text-gray-400 border-transparent hover:bg-gray-50`;
                tabR.className = `flex-1 py-3 font-bold transition-all border-b-2 ${preset.text} border-current`;
            }
            
            document.getElementById('summary-card').style.borderLeftColor = preset.hex;
            document.getElementById('daily-xp').className = `text-xl ${preset.text}`;
        }

        function renderAll() {
            renderQuests();
            renderRewards();
            renderThemeList();
        }

        function renderQuests() {
            const theme = globalState.themes[globalState.currentTheme];
            const preset = colorPresets[theme.accent];
            const container = document.getElementById('quest-categories-container');
            container.innerHTML = '';

            Object.keys(theme.customQuests).forEach(catKey => {
                const category = theme.customQuests[catKey];
                const section = document.createElement('section');

                let itemsHtml = '';
                category.items.forEach((item, index) => {
                    const isChecked = theme.dailyChecked[item.id] || false;

                    itemsHtml += `
                        <div onclick="toggleQuest('${catKey}', ${index})" class="quest-card bg-white p-3 rounded-xl shadow-sm flex items-center justify-between border-2 ${isChecked ? preset.border + ' ' + preset.light : 'border-transparent'} cursor-pointer hover:border-gray-200 select-none">
                            <div class="flex-1 mr-4">
                                <h4 class="font-semibold text-sm ${isChecked ? 'text-gray-400' : 'text-gray-700'}">${item.label}</h4>
                                <span class="text-[10px] font-bold ${item.xp > 0 ? preset.text : 'text-red-500'}">${item.xp > 0 ? '+' : ''}${item.xp} XP</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${isEditMode ? `
                                    <button onclick="event.stopPropagation(); openEditQuestModal('${catKey}', ${index})" class="p-2 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteQuest('${catKey}', ${index})" class="p-2 bg-red-50 text-red-400 rounded-lg hover:bg-red-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    </button>
                                ` : `
                                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${isChecked ? preset.bg + ' border-transparent' : 'border-gray-200'}">
                                        ${isChecked ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                                    </div>
                                `}
                            </div>
                        </div>`;
                });

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-3 mt-6">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">${category.title}</h3>
                        ${isEditMode ? `<button onclick="openEditQuestModal('${catKey}')" class="text-xs font-bold ${preset.text} bg-white px-2 py-1 rounded-md shadow-sm">+ Quest</button>` : ''}
                    </div>
                    <div class="space-y-2">${itemsHtml || '<p class="text-center text-xs text-gray-400 py-4 border-2 border-dashed border-gray-200 rounded-xl">Belum ada quest di kategori ini</p>'}</div>`;
                container.appendChild(section);
            });
        }

        // New Logic: Toggle immediately updates Total XP and Auto-Saves
        function toggleQuest(catKey, index) {
            if (isEditMode) return;
            
            const theme = globalState.themes[globalState.currentTheme];
            const item = theme.customQuests[catKey].items[index];
            const today = new Date().toLocaleDateString();

            // Check for new day before processing action
            if (theme.lastActiveDate && theme.lastActiveDate !== today) {
                // It's a new day! Reset checks first.
                theme.dailyChecked = {};
                // Increment streak since this is the first action of the new day
                theme.streak++;
                createConfetti(); 
            } else if (!theme.lastActiveDate) {
                // First time ever using or migrated
                theme.streak = 1;
            }

            if (theme.dailyChecked[item.id]) {
                // Uncheck: Remove XP
                delete theme.dailyChecked[item.id];
                theme.totalXp -= item.xp;
            } else {
                // Check: Add XP
                theme.dailyChecked[item.id] = true;
                theme.totalXp += item.xp;
            }
            
            if(theme.totalXp < 0) theme.totalXp = 0;
            
            theme.lastActiveDate = today;
            saveToStorage();
            renderQuests();
            updateUI();
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('edit-indicator').classList.toggle('hidden', !isEditMode);
            const btnEdit = document.getElementById('btn-edit-mode');
            if (isEditMode) {
                btnEdit.classList.add('text-indigo-600', 'bg-indigo-50');
                btnEdit.classList.remove('text-gray-400');
            } else {
                btnEdit.classList.remove('text-indigo-600', 'bg-indigo-50');
                btnEdit.classList.add('text-gray-400');
            }
            renderQuests();
        }

        function switchView(view) {
            activeView = view;
            document.getElementById('view-quests').classList.toggle('hidden', view !== 'quests');
            document.getElementById('view-rewards').classList.toggle('hidden', view !== 'rewards');
            applyThemeStyles();
        }

        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        }

        function switchTheme(key) {
            globalState.currentTheme = key;
            saveToStorage();
            toggleThemeMenu();
            applyThemeStyles();
            renderAll();
            updateUI();
        }

        function resetDaily() {
            const theme = globalState.themes[globalState.currentTheme];
            showConfirm("Reset semua centang quest hari ini? (XP yang didapat hari ini akan dibatalkan)", () => {
                // We need to subtract the XP gained today before clearing
                Object.keys(theme.dailyChecked).forEach(id => {
                    Object.values(theme.customQuests).forEach(cat => {
                         const item = cat.items.find(i => i.id === id);
                         if (item) theme.totalXp -= item.xp;
                    });
                });
                if(theme.totalXp < 0) theme.totalXp = 0;

                theme.dailyChecked = {};
                saveToStorage();
                renderQuests();
                updateUI();
            });
        }

        // Title System
        function getTitleByXP(xp) {
            let current = titles[0].name;
            titles.forEach(t => { if (xp >= t.xp) current = t.name; });
            return current;
        }

        function openEditTitlesModal() {
            const container = document.getElementById('titles-list');
            container.innerHTML = '';
            titles.forEach((t, i) => {
                container.innerHTML += `
                    <div class="flex gap-2 items-center">
                        <input type="text" value="${t.name}" onchange="titles[${i}].name=this.value" class="flex-1 p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm outline-none focus:border-indigo-400">
                        <input type="number" value="${t.xp}" onchange="titles[${i}].xp=parseInt(this.value)" class="w-20 p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm outline-none focus:border-indigo-400">
                        <button onclick="titles.splice(${i},1); openEditTitlesModal()" class="text-red-400 hover:text-red-600 p-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
            });
            document.getElementById('edit-titles-modal').classList.remove('hidden');
            document.getElementById('edit-titles-modal').classList.add('flex');
        }

        function closeEditTitlesModal() { document.getElementById('edit-titles-modal').classList.add('hidden'); }
        function addNewTitle() { titles.push({name: 'Gelar Baru', xp: titles[titles.length-1].xp + 1000}); openEditTitlesModal(); }
        function saveTitles() { titles.sort((a,b)=>a.xp-b.xp); saveToStorage(); updateUI(); closeEditTitlesModal(); }

        // Quest Edit/Delete
        function openEditQuestModal(cat, idx = null) {
            currentQuestCategory = cat;
            currentQuestIndex = idx;
            const q = idx !== null ? globalState.themes[globalState.currentTheme].customQuests[cat].items[idx] : {label:'', xp:0};
            document.getElementById('quest-name').value = q.label;
            document.getElementById('quest-xp').value = q.xp;
            document.getElementById('edit-quest-modal').classList.replace('hidden', 'flex');
        }
        function closeEditQuestModal() { document.getElementById('edit-quest-modal').classList.replace('flex', 'hidden'); }
        function saveQuest() {
            const label = document.getElementById('quest-name').value;
            const xpVal = document.getElementById('quest-xp').value;
            if (!label || !xpVal) return;
            
            const xp = parseInt(xpVal);
            const cat = globalState.themes[globalState.currentTheme].customQuests[currentQuestCategory];
            if (currentQuestIndex !== null) {
                cat.items[currentQuestIndex] = {...cat.items[currentQuestIndex], label, xp};
            } else {
                cat.items.push({id: 'q'+Date.now(), label, xp});
            }
            saveToStorage(); renderQuests(); closeEditQuestModal();
        }
        function deleteQuest(cat, idx) {
            showConfirm("Hapus quest ini permanen?", () => {
                globalState.themes[globalState.currentTheme].customQuests[cat].items.splice(idx, 1);
                saveToStorage(); 
                renderQuests();
            });
        }

        // Theme Management
        function renderThemeList() {
            const container = document.getElementById('theme-list-container');
            container.innerHTML = '';
            Object.keys(globalState.themes).forEach(key => {
                const t = globalState.themes[key];
                const preset = colorPresets[t.accent];
                const isActive = globalState.currentTheme === key;
                
                container.innerHTML += `
                    <div class="flex gap-2 items-stretch">
                        <button onclick="switchTheme('${key}')" class="flex-1 text-left p-4 rounded-xl ${preset.light} border-2 ${isActive ? preset.border : 'border-transparent'} hover:border-gray-200 transition-all">
                            <span class="font-bold ${preset.text}">${t.title}</span>
                            <div class="text-xs text-gray-500 mt-1">Lvl ${Math.floor(t.totalXp/500)+1} ‚Ä¢ ${t.streak} Hari Streak</div>
                        </button>
                        ${Object.keys(globalState.themes).length > 1 ? `
                            <button onclick="deleteTheme('${key}')" class="px-4 text-red-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        ` : ''}
                    </div>`;
            });
        }
        function openAddThemeModal() { document.getElementById('add-theme-modal').classList.replace('hidden', 'flex'); }
        function closeAddThemeModal() { document.getElementById('add-theme-modal').classList.replace('flex', 'hidden'); }
        function addNewTheme() {
            const name = document.getElementById('new-theme-title').value;
            const accent = document.getElementById('new-theme-accent').value;
            if(!name) return;
            const key = 't' + Date.now();
            globalState.themes[key] = {
                title: name, accent, totalXp:0, dailyChecked:{}, streak:0, lastActiveDate:'',
                customQuests: { wajib: {title: "Wajib", items:[]}, bonus: {title: "Bonus", items:[]}, negatif: {title: "Penalty", items:[]} },
                rewards: []
            };
            saveToStorage(); renderThemeList(); closeAddThemeModal();
            switchTheme(key);
        }
        function deleteTheme(key) {
            if(Object.keys(globalState.themes).length <= 1) return;
            showConfirm(`Hapus tema "${globalState.themes[key].title}" dan semua progresnya?`, () => {
                delete globalState.themes[key];
                if(globalState.currentTheme === key) globalState.currentTheme = Object.keys(globalState.themes)[0];
                saveToStorage(); renderThemeList(); switchTheme(globalState.currentTheme);
            });
        }

        function updateUI() {
            const theme = globalState.themes[globalState.currentTheme];
            const level = Math.floor(theme.totalXp / 500) + 1;
            const xpInLevel = theme.totalXp % 500;
            
            document.getElementById('level-badge').innerText = `LVL ${level}`;
            document.getElementById('xp-text').innerText = `${xpInLevel} / 500 XP`;
            document.getElementById('xp-progress-bar').style.width = `${(xpInLevel / 500) * 100}%`;
            document.getElementById('total-xp').innerText = theme.totalXp;
            document.getElementById('streak-count').innerText = `${theme.streak} Hari`;
            document.getElementById('theme-title').innerText = theme.title;
            
            let daily = 0;
            Object.keys(theme.dailyChecked).forEach(id => {
                Object.values(theme.customQuests).forEach(cat => {
                    const item = cat.items.find(i => i.id === id);
                    if(item) daily += item.xp;
                });
            });
            document.getElementById('daily-xp').innerText = daily;
            
            const title = getTitleByXP(theme.totalXp);
            const xpTitleElement = document.getElementById('xp-title');
            xpTitleElement.innerText = title;
            xpTitleElement.style.color = colorPresets[theme.accent].hex;
            xpTitleElement.style.borderColor = colorPresets[theme.accent].hex + '40';
        }

        function renderRewards() {
            const theme = globalState.themes[globalState.currentTheme];
            const container = document.getElementById('rewards-container');
            const emptyMsg = document.getElementById('empty-rewards-msg');
            container.innerHTML = '';
            
            if (!theme.rewards || theme.rewards.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            theme.rewards.forEach((r, idx) => {
                const progress = Math.min((theme.totalXp / r.cost) * 100, 100);
                const isCompleted = progress >= 100;
                
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm relative overflow-hidden group">
                        <div class="flex justify-between mb-2 relative z-10">
                            <span class="font-bold text-gray-700">${r.name} ${isCompleted ? 'üéâ' : ''}</span>
                            <span class="text-xs font-bold ${isCompleted ? 'text-green-600' : 'text-gray-400'}">${theme.totalXp} / ${r.cost} XP</span>
                        </div>
                        <div class="w-full bg-gray-100 h-3 rounded-full overflow-hidden relative z-10">
                            <div class="${isCompleted ? 'bg-green-500' : colorPresets[theme.accent].bg} h-full transition-all duration-700" style="width: ${progress}%"></div>
                        </div>
                        <button onclick="deleteReward(${idx})" class="absolute top-1 right-2 text-[10px] text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-20">hapus</button>
                    </div>`;
            });
        }

        function openAddRewardModal() {
            showPrompt((name, cost) => {
                const costNum = parseInt(cost);
                if (name && costNum) {
                    if (!globalState.themes[globalState.currentTheme].rewards) {
                         globalState.themes[globalState.currentTheme].rewards = [];
                    }
                    globalState.themes[globalState.currentTheme].rewards.push({name, cost: costNum});
                    saveToStorage(); renderRewards();
                }
            });
        }

        function deleteReward(idx) {
            showConfirm("Hapus target hadiah ini?", () => {
                 globalState.themes[globalState.currentTheme].rewards.splice(idx, 1);
                 saveToStorage(); renderRewards();
            });
        }

        function createConfetti() {
            for(let i=0; i<40; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = ['#ff0', '#f0f', '#0ff', '#0f0', '#ff4d4d'][Math.floor(Math.random()*5)];
                c.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify({state: globalState, titles: titles})], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quest_master_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.state && data.titles) {
                            showConfirm("Data saat ini akan ditimpa dengan data backup. Lanjutkan?", () => {
                                globalState = data.state;
                                titles = data.titles;
                                saveToStorage(); 
                                location.reload();
                            });
                        } else {
                            showMessage("File backup tidak valid.", "‚ùå");
                        }
                    } catch(err) {
                        showMessage("Gagal membaca file.", "‚ùå");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        init();
    </script>
</body>
</html>
